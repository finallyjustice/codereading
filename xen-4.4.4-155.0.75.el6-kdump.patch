From 303faa4543ab55cc18a9fd7fa5e3099a71fafde9 Mon Sep 17 00:00:00 2001
From: Dongli Zhang <dongli.zhang0129@gmail.com>
Date: Thu, 9 Apr 2020 16:14:36 -0700
Subject: [PATCH 1/1] xen-4.4.4-155.0.75.el6-kdump

xen-4.4.4-155.0.75

Signed-off-by: Dongli Zhang <dongli.zhang0129@gmail.com>
---
 xen/arch/x86/crash.c  | 11 +++++++++++
 xen/common/domain.c   | 11 +++++++++++
 xen/common/kexec.c    | 20 ++++++++++++++++++++
 xen/common/shutdown.c |  4 ++++
 4 files changed, 46 insertions(+)

diff --git a/xen/arch/x86/crash.c b/xen/arch/x86/crash.c
index c5332a5ea2..69e9ecf0cc 100644
--- a/xen/arch/x86/crash.c
+++ b/xen/arch/x86/crash.c
@@ -113,6 +113,10 @@ void __attribute__((noreturn)) do_nmi_crash(struct cpu_user_regs *regs)
         halt();
 }
 
+/*
+ * called by:
+ *   - arch/x86/crash.c|187| <<machine_crash_shutdown>> nmi_shootdown_cpus();
+ */
 static void nmi_shootdown_cpus(void)
 {
     unsigned long msecs;
@@ -180,10 +184,17 @@ static void nmi_shootdown_cpus(void)
     hpet_disable();
 }
 
+/*
+ * called by:
+ *   - common/kexec.c|368| <<kexec_crash>> machine_crash_shutdown();
+ */
 void machine_crash_shutdown(void)
 {
     crash_xen_info_t *info;
 
+    /*
+     * 打印: Shot down all CPUs
+     */
     nmi_shootdown_cpus();
 
     info = kexec_crash_save_info();
diff --git a/xen/common/domain.c b/xen/common/domain.c
index fcb13abf33..01df319807 100644
--- a/xen/common/domain.c
+++ b/xen/common/domain.c
@@ -694,6 +694,17 @@ void __domain_crash_synchronous(void)
 }
 
 
+/*
+ * called by:
+ *   - arch/x86/hvm/hvm.c|1504| <<hvm_vcpu_down>> domain_shutdown(d, SHUTDOWN_poweroff);
+ *   - arch/x86/hvm/hvm.c|1567| <<hvm_triple_fault>> domain_shutdown(d, reason);
+ *   - common/domain.c|682| <<__domain_crash>> domain_shutdown(d, SHUTDOWN_crash);
+ *   - common/page_alloc.c|1125| <<offline_page>> domain_shutdown(owner, SHUTDOWN_crash);
+ *   - common/schedule.c|807| <<domain_watchdog_timeout>> domain_shutdown(d, SHUTDOWN_watchdog);
+ *   - common/schedule.c|893| <<do_sched_op_compat>> domain_shutdown(current->domain, (u8)arg);
+ *   - common/schedule.c|938| <<do_sched_op(SCHEDOP_shutdown)>> domain_shutdown(current->domain, (u8)sched_shutdown.reason);
+ *   - common/schedule.c|998| <<do_sched_op(SCHEDOP_remote_shutdown)>> domain_shutdown(d, (u8)sched_remote_shutdown.reason);
+ */
 void domain_shutdown(struct domain *d, u8 reason)
 {
     struct vcpu *v;
diff --git a/xen/common/kexec.c b/xen/common/kexec.c
index 44ae95d52f..09975e989c 100644
--- a/xen/common/kexec.c
+++ b/xen/common/kexec.c
@@ -242,6 +242,10 @@ void __init set_kexec_crash_area_size(u64 system_ram)
  * This is noinline to make it obvious in stack traces which cpus have lost
  * the race (as opposed to being somewhere in kexec_common_shutdown())
  */
+/*
+ * called by:
+ *   - common/kexec.c|325| <<kexec_common_shutdown>> ret = one_cpu_only();
+ */
 static int noinline one_cpu_only(void)
 {
     static unsigned int crashing_cpu = -1;
@@ -318,6 +322,11 @@ crash_xen_info_t *kexec_crash_save_info(void)
     return out;
 }
 
+/*
+ * called by:
+ *   - common/kexec.c|347| <<kexec_crash>> if ( kexec_common_shutdown() != 0 )
+ *   - common/kexec.c|363| <<kexec_reboot>> kexec_common_shutdown();
+ */
 static int kexec_common_shutdown(void)
 {
     int ret;
@@ -334,6 +343,14 @@ static int kexec_common_shutdown(void)
     return 0;
 }
 
+/*
+ * called by:
+ *   - common/kexec.c|373| <<do_crashdump_trigger>> kexec_crash();
+ *   - common/kexec.c|809| <<kexec_exec(KEXEC_TYPE_CRASH)>> kexec_crash();
+ *   - common/shutdown.c|51| <<dom0_shutdown>> kexec_crash();
+ *   - common/shutdown.c|68| <<dom0_shutdown>> kexec_crash();
+ *   - drivers/char/console.c|1072| <<panic>> kexec_crash();
+ */
 void kexec_crash(void)
 {
     int pos;
@@ -348,6 +365,9 @@ void kexec_crash(void)
         return;
 
     kexec_crash_save_cpu();
+    /*
+     * 打印: Shot down all CPUs
+     */
     machine_crash_shutdown();
     machine_kexec(kexec_image[KEXEC_IMAGE_CRASH_BASE + pos]);
 
diff --git a/xen/common/shutdown.c b/xen/common/shutdown.c
index 90ee384212..162a7e59e1 100644
--- a/xen/common/shutdown.c
+++ b/xen/common/shutdown.c
@@ -32,6 +32,10 @@ static void maybe_reboot(void)
     }
 }
 
+/*
+ * called by:
+ *   - common/domain.c|708| <<domain_shutdown>> dom0_shutdown(reason);
+ */
 void dom0_shutdown(u8 reason)
 {
     switch ( reason )
-- 
2.17.1

