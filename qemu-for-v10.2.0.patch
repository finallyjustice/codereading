From fb41d6471ecce268407c41cbb065dad6b019599c Mon Sep 17 00:00:00 2001
From: Dongli Zhang <dongli.zhang0129@gmail.com>
Date: Sat, 3 Jan 2026 18:51:09 -0800
Subject: [PATCH 1/1] qemu for v10.2.0

Signed-off-by: Dongli Zhang <dongli.zhang0129@gmail.com>
---
 hw/i386/amd_iommu.c   |  9 +++++++++
 hw/i386/intel_iommu.c |  9 +++++++++
 hw/i386/microvm.c     |  9 +++++++++
 hw/i386/pc.c          |  9 +++++++++
 hw/intc/ioapic.c      | 18 ++++++++++++++++++
 include/hw/i386/x86.h |  9 +++++++++
 6 files changed, 63 insertions(+)

diff --git a/hw/i386/amd_iommu.c b/hw/i386/amd_iommu.c
index d689a06ec..90a7b20a0 100644
--- a/hw/i386/amd_iommu.c
+++ b/hw/i386/amd_iommu.c
@@ -2573,6 +2573,15 @@ static void amdvi_sysbus_realize(DeviceState *dev, Error **errp)
     memory_region_add_subregion_overlap(&s->mr_sys, AMDVI_INT_ADDR_FIRST,
                                         &s->mr_ir, 1);
 
+    /*
+     * 在以下使用X86MachineState->ioapic_as:
+     *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+     *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+     *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+     *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+     */
     /* Pseudo address space under root PCI bus. */
     x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
 
diff --git a/hw/i386/intel_iommu.c b/hw/i386/intel_iommu.c
index 78b142cce..ff761e97b 100644
--- a/hw/i386/intel_iommu.c
+++ b/hw/i386/intel_iommu.c
@@ -5456,6 +5456,15 @@ static void vtd_realize(DeviceState *dev, Error **errp)
                                                   g_free, vtd_hiod_destroy);
     vtd_init(s);
     pci_setup_iommu(bus, &vtd_iommu_ops, dev);
+    /*
+     * 在以下使用X86MachineState->ioapic_as:
+     *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+     *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+     *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+     *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+     */
     /* Pseudo address space under root PCI bus. */
     x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
 }
diff --git a/hw/i386/microvm.c b/hw/i386/microvm.c
index 94d22a232..589e0d712 100644
--- a/hw/i386/microvm.c
+++ b/hw/i386/microvm.c
@@ -340,6 +340,15 @@ static void microvm_memory_init(MicrovmMachineState *mms)
     }
 
     x86ms->fw_cfg = fw_cfg;
+    /*
+     * 在以下使用X86MachineState->ioapic_as:
+     *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+     *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+     *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+     *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+     */
     x86ms->ioapic_as = &address_space_memory;
 }
 
diff --git a/hw/i386/pc.c b/hw/i386/pc.c
index f8b919cb6..3bb93d737 100644
--- a/hw/i386/pc.c
+++ b/hw/i386/pc.c
@@ -1007,6 +1007,15 @@ void pc_memory_init(PCMachineState *pcms,
     }
     x86ms->fw_cfg = fw_cfg;
 
+    /*
+     * 在以下使用X86MachineState->ioapic_as:
+     *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+     *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+     *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+     *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+     */
     /* Init default IOAPIC address space */
     x86ms->ioapic_as = &address_space_memory;
 
diff --git a/hw/intc/ioapic.c b/hw/intc/ioapic.c
index 38e438464..2975e21a0 100644
--- a/hw/intc/ioapic.c
+++ b/hw/intc/ioapic.c
@@ -96,6 +96,15 @@ static void ioapic_entry_parse(uint64_t entry, struct ioapic_entry_info *info)
 
 static void ioapic_service(IOAPICCommonState *s)
 {
+    /*
+     * 在以下使用X86MachineState->ioapic_as:
+     *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+     *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+     *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+     *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+     */
     AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
     struct ioapic_entry_info info;
     uint8_t i;
@@ -137,6 +146,15 @@ static void ioapic_service(IOAPICCommonState *s)
                 }
 #endif
 
+                /*
+		 * 在以下使用X86MachineState->ioapic_as:
+                 *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+                 *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+                 *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+                 *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+                 *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+                 *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+		 */
                 /* No matter whether IR is enabled, we translate
                  * the IOAPIC message into a MSI one, and its
                  * address space will decide whether we need a
diff --git a/include/hw/i386/x86.h b/include/hw/i386/x86.h
index 8755cad50..30ceb73de 100644
--- a/include/hw/i386/x86.h
+++ b/include/hw/i386/x86.h
@@ -85,6 +85,15 @@ struct X86MachineState {
      * Address space used by IOAPIC device. All IOAPIC interrupts
      * will be translated to MSI messages in the address space.
      */
+    /*
+     * 在以下使用X86MachineState->ioapic_as:
+     *   - hw/i386/amd_iommu.c|2577| <<amdvi_sysbus_realize>> x86ms->ioapic_as = amdvi_host_dma_iommu(bus, s, AMDVI_IOAPIC_SB_DEVID);
+     *   - hw/i386/intel_iommu.c|5460| <<vtd_realize>> x86ms->ioapic_as = vtd_host_dma_iommu(bus, s, Q35_PSEUDO_DEVFN_IOAPIC);
+     *   - hw/i386/microvm.c|343| <<microvm_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/i386/pc.c|1011| <<pc_memory_init>> x86ms->ioapic_as = &address_space_memory;
+     *   - hw/intc/ioapic.c|99| <<ioapic_service>> AddressSpace *ioapic_as = X86_MACHINE(qdev_get_machine())->ioapic_as;
+     *   - hw/intc/ioapic.c|144| <<ioapic_service>> stl_le_phys(ioapic_as, info.addr, info.data);
+     */
     AddressSpace *ioapic_as;
 
     /*
-- 
2.50.1 (Apple Git-155)

