# echo 100 > /sys/kernel/mm/ksm/pages_to_scan
# echo 1 > /sys/kernel/mm/ksm/run

---

hv# /usr/share/bcc/tools/stackcount -K  -T  'kvm_mmu_notifier_change_pte'
Tracing 1 functions for "kvm_mmu_notifier_change_pte"... Hit Ctrl-C to end.
^C
18:08:00
  kvm_mmu_notifier_change_pte
  __mmu_notifier_change_pte
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    44

  kvm_mmu_notifier_change_pte
  __mmu_notifier_change_pte
  replace_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    44

  kvm_mmu_notifier_change_pte
  __mmu_notifier_change_pte
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    44

  kvm_mmu_notifier_change_pte
  __mmu_notifier_change_pte
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    674

  kvm_mmu_notifier_change_pte
  __mmu_notifier_change_pte
  replace_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    674

  kvm_mmu_notifier_change_pte
  __mmu_notifier_change_pte
  wp_page_copy
  __handle_mm_fault
  handle_mm_fault
  __get_user_pages
  get_user_pages_unlocked
  hva_to_pfn
  __kvm_faultin_pfn
  kvm_faultin_pfn
  kvm_tdp_page_fault
  kvm_mmu_do_page_fault
  kvm_mmu_page_fault
  vmx_handle_exit
  vcpu_enter_guest.constprop.0
  vcpu_run
  kvm_arch_vcpu_ioctl_run
  kvm_vcpu_ioctl
  __x64_sys_ioctl
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    13938

Detaching...

---

hv# /usr/share/bcc/tools/stackcount -K  -T  'tdp_mmu_zap_leafs'
Tracing 1 functions for "tdp_mmu_zap_leafs"... Hit Ctrl-C to end.
^C
18:10:00
  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    3

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    3

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    93

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  replace_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    93

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    93

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  wp_page_copy
  __handle_mm_fault
  handle_mm_fault
  __get_user_pages
  get_user_pages_unlocked
  hva_to_pfn
  __kvm_faultin_pfn
  kvm_faultin_pfn
  kvm_tdp_page_fault
  kvm_mmu_do_page_fault
  kvm_mmu_page_fault
  vmx_handle_exit
  vcpu_enter_guest.constprop.0
  vcpu_run
  kvm_arch_vcpu_ioctl_run
  kvm_vcpu_ioctl
  __x64_sys_ioctl
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    241

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    605

  tdp_mmu_zap_leafs
  kvm_tdp_mmu_unmap_gfn_range
  kvm_unmap_gfn_range
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  replace_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    605

Detaching...

---

hv# /usr/share/bcc/tools/stackcount -K  -T  'kvm_mmu_notifier_invalidate_range_start'
Tracing 1 functions for "kvm_mmu_notifier_invalidate_range_start"... Hit Ctrl-C to end.
^C
18:17:58
  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  vma_adjust_trans_huge
  __split_vma
  mprotect_fixup
  do_mprotect_pkey
  __x64_sys_mprotect
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    1

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  vma_adjust_trans_huge
  __split_vma
  mprotect_fixup
  do_mprotect_pkey
  __x64_sys_mprotect
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    1

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  vma_merge
  mprotect_fixup
  do_mprotect_pkey
  __x64_sys_mprotect
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    3

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    4

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    4

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    4

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    4

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  collapse_huge_page
  hpage_collapse_scan_pmd
  khugepaged_scan_mm_slot.constprop.0
  khugepaged
  kthread
  ret_from_fork
  ret_from_fork_asm
    14

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  wp_page_copy
  __handle_mm_fault
  handle_mm_fault
  do_user_addr_fault
  exc_page_fault
  asm_exc_page_fault
    16

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  do_huge_pmd_wp_page
  __handle_mm_fault
  handle_mm_fault
  __get_user_pages
  get_user_pages_unlocked
  hva_to_pfn
  __kvm_faultin_pfn
  kvm_faultin_pfn
  kvm_tdp_page_fault
  kvm_mmu_do_page_fault
  kvm_mmu_page_fault
  vmx_handle_exit
  vcpu_enter_guest.constprop.0
  vcpu_run
  kvm_arch_vcpu_ioctl_run
  kvm_vcpu_ioctl
  __x64_sys_ioctl
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    30

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  __split_huge_pmd
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    45

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  try_to_migrate_one
  rmap_walk_anon
  try_to_migrate
  split_huge_page_to_list
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    45

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  unmap_vmas
  unmap_region.constprop.0
  do_vmi_align_munmap
  do_vmi_munmap
  __vm_munmap
  __x64_sys_munmap
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    129

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  zap_page_range_single
  madvise_vma_behavior
  do_madvise
  __x64_sys_madvise
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    391

    481

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    481

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  replace_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    481

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  change_pmd_range.isra.0
  change_protection_range
  mprotect_fixup
  do_mprotect_pkey
  __x64_sys_mprotect
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    528

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  replace_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    6667

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  write_protect_page
  try_to_merge_one_page
  try_to_merge_with_ksm_page
  cmp_and_merge_page
  ksm_scan_thread
  kthread
  ret_from_fork
  ret_from_fork_asm
    6667

  kvm_mmu_notifier_invalidate_range_start
  __mmu_notifier_invalidate_range_start
  wp_page_copy
  __handle_mm_fault
  handle_mm_fault
  __get_user_pages
  get_user_pages_unlocked
  hva_to_pfn
  __kvm_faultin_pfn
  kvm_faultin_pfn
  kvm_tdp_page_fault
  kvm_mmu_do_page_fault
  kvm_mmu_page_fault
  vmx_handle_exit
  vcpu_enter_guest.constprop.0
  vcpu_run
  kvm_arch_vcpu_ioctl_run
  kvm_vcpu_ioctl
  __x64_sys_ioctl
  do_syscall_64
  entry_SYSCALL_64_after_hwframe
    15991

Detaching...
