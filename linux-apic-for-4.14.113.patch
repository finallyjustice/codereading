From 1e5703da7276eb3756b3ef7becf1bd8ed234fc4e Mon Sep 17 00:00:00 2001
From: Dongli Zhang <dongli.zhang0129@gmail.com>
Date: Wed, 8 May 2019 05:48:21 +0800
Subject: [PATCH 1/1] linux-apic-for-4.14.113

Signed-off-by: Dongli Zhang <dongli.zhang0129@gmail.com>
---
 arch/x86/kernel/apic/io_apic.c | 32 ++++++++++++++++++++++++++++++++
 arch/x86/kernel/i8259.c        |  7 +++++++
 kernel/irq/chip.c              |  3 +++
 3 files changed, 42 insertions(+)

diff --git a/arch/x86/kernel/apic/io_apic.c b/arch/x86/kernel/apic/io_apic.c
index 96a8a68..67e3937 100644
--- a/arch/x86/kernel/apic/io_apic.c
+++ b/arch/x86/kernel/apic/io_apic.c
@@ -1597,6 +1597,10 @@ __setup("no_timer_check", notimercheck);
  */
 static int __init timer_irq_works(void)
 {
+	/*
+	 * jiffies和jiffies_64是一样的, 定义在
+	 * arch/x86/kernel/vmlinux.lds.S
+	 */
 	unsigned long t1 = jiffies;
 	unsigned long flags;
 
@@ -2029,6 +2033,9 @@ static int mp_alloc_timer_irq(int ioapic, int pin)
  */
 static inline void __init check_timer(void)
 {
+	/*
+	 * 获得irq 0的struct irq_desc *desc, 返回desc->irq_data
+	 */
 	struct irq_data *irq_data = irq_get_irq_data(0);
 	struct mp_chip_data *data = irq_data->chip_data;
 	struct irq_cfg *cfg = irqd_cfg(irq_data);
@@ -2042,6 +2049,13 @@ static inline void __init check_timer(void)
 	/*
 	 * get/set the timer IRQ vector:
 	 */
+	/*
+	 * legacy_pic可以是:
+	 *   - default_legacy_pic
+	 *   - null_legacy_pic
+	 *
+	 * 这里的参数0是irq
+	 */
 	legacy_pic->mask(0);
 
 	/*
@@ -2061,6 +2075,13 @@ static inline void __init check_timer(void)
 	pin2  = ioapic_i8259.pin;
 	apic2 = ioapic_i8259.apic;
 
+	/*
+	 * 在测试xen domU中boot和kdump的例子都是:
+	 * ..TIMER: vector=0x30 apic1=0 pin1=2 apic2=0 pin2=0
+	 *
+	 * 在8-thread的dell测试机kvm的VM里:
+	 * ..TIMER: vector=0x30 apic1=0 pin1=2 apic2=-1 pin2=-1
+	 */
 	apic_printk(APIC_QUIET, KERN_INFO "..TIMER: vector=0x%02X "
 		    "apic1=%d pin1=%d apic2=%d pin2=%d\n",
 		    cfg->vector, apic1, pin1, apic2, pin2);
@@ -2072,6 +2093,14 @@ static inline void __init check_timer(void)
 	 * was found above, try it both directly and through the
 	 * 8259A.
 	 */
+	/*
+	 * 在测试xen domU中boot和kdump的例子都是:
+	 *
+	 * pin1 = 2
+	 * pin2 = 0
+	 *
+	 * 所以下面的no_pin1应该是0
+	 */
 	if (pin1 == -1) {
 		panic_if_irq_remap("BIOS bug: timer not connected to IO-APIC");
 		pin1 = pin2;
@@ -2088,6 +2117,9 @@ static inline void __init check_timer(void)
 			mp_alloc_timer_irq(apic1, pin1);
 		} else {
 			/*
+			 * 目前测试的kvm和xen都是执行这里
+			 */
+			/*
 			 * for edge trigger, it's already unmasked,
 			 * so only need to unmask if it is level-trigger
 			 * do we really have level trigger timer?
diff --git a/arch/x86/kernel/i8259.c b/arch/x86/kernel/i8259.c
index 02abc13..03589ff 100644
--- a/arch/x86/kernel/i8259.c
+++ b/arch/x86/kernel/i8259.c
@@ -419,6 +419,13 @@ struct legacy_pic default_legacy_pic = {
 	.make_irq = make_8259A_irq,
 };
 
+/*
+ * used by:
+ *   - arch/x86/kernel/i8259.c|422| <<global>> struct legacy_pic *legacy_pic = &default_legacy_pic;
+ *   - arch/x86/kernel/acpi/boot.c|1387| <<acpi_reduced_hw_init>> legacy_pic = &null_legacy_pic;
+ *   - arch/x86/kernel/i8259.c|319| <<probe_8259A>> legacy_pic = &null_legacy_pic;
+ *   - arch/x86/platform/intel-mid/intel-mid.c|200| <<x86_intel_mid_early_setup>> legacy_pic = &null_legacy_pic;
+ */
 struct legacy_pic *legacy_pic = &default_legacy_pic;
 EXPORT_SYMBOL(legacy_pic);
 
diff --git a/kernel/irq/chip.c b/kernel/irq/chip.c
index 317fc75..76f1650 100644
--- a/kernel/irq/chip.c
+++ b/kernel/irq/chip.c
@@ -157,6 +157,9 @@ int irq_set_chip_data(unsigned int irq, void *data)
 }
 EXPORT_SYMBOL(irq_set_chip_data);
 
+/*
+ * 获得irq的struct irq_desc *desc, 返回desc->irq_data
+ */
 struct irq_data *irq_get_irq_data(unsigned int irq)
 {
 	struct irq_desc *desc = irq_to_desc(irq);
-- 
2.7.4

