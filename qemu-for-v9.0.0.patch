From fe47ef6a69e281896dbd776b1ae7c1f5d1c33fd9 Mon Sep 17 00:00:00 2001
From: Dongli Zhang <dongli.zhang0129@gmail.com>
Date: Sun, 26 May 2024 15:47:10 -0700
Subject: [PATCH 1/1] qemu for v9.0.0

Signed-off-by: Dongli Zhang <dongli.zhang0129@gmail.com>
---
 accel/kvm/kvm-all.c | 4 ++++
 system/cpus.c       | 4 ++++
 target/arm/kvm.c    | 5 +++++
 3 files changed, 13 insertions(+)

diff --git a/accel/kvm/kvm-all.c b/accel/kvm/kvm-all.c
index 931f74256..370d9e8bf 100644
--- a/accel/kvm/kvm-all.c
+++ b/accel/kvm/kvm-all.c
@@ -3387,6 +3387,10 @@ int kvm_on_sigbus_vcpu(CPUState *cpu, int code, void *addr)
 #endif
 }
 
+/*
+ * 在以下使用kvm_on_sigbus():
+ *   - system/cpus.c|373| <<sigbus_handler>> if (kvm_on_sigbus(siginfo->si_code, siginfo->si_addr)) {
+ */
 /* Called synchronously (via signalfd) in main thread.  */
 int kvm_on_sigbus(int code, void *addr)
 {
diff --git a/system/cpus.c b/system/cpus.c
index 68d161d96..c3ed8ede1 100644
--- a/system/cpus.c
+++ b/system/cpus.c
@@ -357,6 +357,10 @@ static void sigbus_reraise(void)
     abort();
 }
 
+/*
+ * 在以下使用sigbug_handler():
+ *   - system/cpus.c|389| <<qemu_init_sigbus>> action.sa_sigaction = sigbus_handler;
+ */
 static void sigbus_handler(int n, siginfo_t *siginfo, void *ctx)
 {
     if (siginfo->si_code != BUS_MCEERR_AO && siginfo->si_code != BUS_MCEERR_AR) {
diff --git a/target/arm/kvm.c b/target/arm/kvm.c
index ab85d628a..0db43fe9d 100644
--- a/target/arm/kvm.c
+++ b/target/arm/kvm.c
@@ -2356,6 +2356,11 @@ int kvm_arch_get_registers(CPUState *cs)
     return ret;
 }
 
+/*
+ * called by:
+ *   - accel/kvm/kvm-all.c|2876| <<kvm_cpu_exec>> kvm_arch_on_sigbus_vcpu(cpu, pending_sigbus_code, pending_sigbus_addr);
+ *   - accel/kvm/kvm-all.c|3399| <<kvm_on_sigbus>> kvm_arch_on_sigbus_vcpu(first_cpu, code, addr);
+ */
 void kvm_arch_on_sigbus_vcpu(CPUState *c, int code, void *addr)
 {
     ram_addr_t ram_addr;
-- 
2.34.1

